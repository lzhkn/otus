#!/bin/bash
## Используем bash как интерпретатор.
## Важно для корректной работы под Rocky Linux 9 и cron.

########################################
## НАСТРОЙКИ
########################################

ACCESS_LOG="/var/log/nginx/access.log"
## Путь к access-логу веб-сервера.
## Используется для анализа IP, URL и HTTP-кодов.

ERROR_LOG="/var/log/nginx/error.log"
## Путь к error-логу веб-сервера.
## Используется для получения ошибок приложения/веб-сервера.

MAIL_TO="root"
## Локальный получатель письма.
## Внутренняя почта сервера, без отправки наружу.

HOSTNAME="$(hostname)"
## Имя хоста.
## Используется в теме письма и теле отчёта для идентификации сервера.

STATE_DIR="/var/lib/web_report"
## Каталог для хранения состояния между запусками скрипта.
## Позволяет обрабатывать только новые записи логов.

LOCK_FILE="/var/run/web_report.lock"
## Lock-файл для защиты от одновременного запуска нескольких копий скрипта.

mkdir -p "$STATE_DIR"
## Создаём каталог состояния, если его ещё нет.

ACCESS_POS_FILE="$STATE_DIR/access.pos"
## Файл с последней обработанной позицией access-лога (в байтах).

ERROR_POS_FILE="$STATE_DIR/error.pos"
## Файл с последней обработанной позицией error-лога (в байтах).

NOW="$(date '+%Y-%m-%d %H:%M:%S')"
## Текущее время — конец обрабатываемого интервала.

START_TIME="$(date -d '1 hour ago' '+%Y-%m-%d %H:%M:%S')"
## Начало временного диапазона отчёта.
## Используется для отображения периода в письме.

########################################
## ЗАЩИТА ОТ ПАРАЛЛЕЛЬНОГО ЗАПУСКА
########################################

exec 9>"$LOCK_FILE" || exit 1
## Открываем lock-файл в файловом дескрипторе 9.

flock -n 9 || exit 0
## Если файл уже заблокирован другим процессом — скрипт завершается.
## Это предотвращает одновременный запуск нескольких экземпляров.

########################################
## ЧТЕНИЕ ПОЗИЦИЙ
########################################

ACCESS_POS=$(cat "$ACCESS_POS_FILE" 2>/dev/null || echo 0)
## Считываем позицию последнего чтения access-лога.
## Если файл отсутствует — начинаем с начала (0).

ERROR_POS=$(cat "$ERROR_POS_FILE" 2>/dev/null || echo 0)
## Аналогично для error-лога.

ACCESS_SIZE=$(stat -c%s "$ACCESS_LOG" 2>/dev/null || echo 0)
## Текущий размер access-лога в байтах.

ERROR_SIZE=$(stat -c%s "$ERROR_LOG" 2>/dev/null || echo 0)
## Текущий размер error-лога в байтах.

## Защита от logrotate:
## если лог был ротирован и стал меньше, читаем его с начала.
(( ACCESS_POS > ACCESS_SIZE )) && ACCESS_POS=0
(( ERROR_POS > ERROR_SIZE )) && ERROR_POS=0

########################################
## ЧТЕНИЕ НОВЫХ ДАННЫХ
########################################

ACCESS_DATA=$(dd if="$ACCESS_LOG" bs=1 skip="$ACCESS_POS" 2>/dev/null)
## Считываем только новые данные access-лога,
## начиная с последней сохранённой позиции.

ERROR_DATA=$(dd if="$ERROR_LOG" bs=1 skip="$ERROR_POS" 2>/dev/null)
## Аналогично для error-лога.

echo "$ACCESS_SIZE" > "$ACCESS_POS_FILE"
## Сохраняем новую позицию access-лога для следующего запуска.

echo "$ERROR_SIZE" > "$ERROR_POS_FILE"
## Сохраняем новую позицию error-лога.

########################################
## ФОРМИРОВАНИЕ ОТЧЁТА
########################################

REPORT=$(cat <<EOF
Отчёт о работе веб-сервера
Хост: $HOSTNAME
Период: $START_TIME — $NOW

=================================
TOP IP-адреса
=================================
$(echo "$ACCESS_DATA" | awk '{print $1}' | sort | uniq -c | sort -nr | head)
## Извлекаем IP-адреса (1-е поле access-лога),
## считаем количество запросов и выводим TOP.

=================================
TOP URL
=================================
$(echo "$ACCESS_DATA" | awk '{print $7}' | sort | uniq -c | sort -nr | head)
## Извлекаем запрашиваемые URL (7-е поле),
## считаем и выводим наиболее популярные.

=================================
HTTP-коды ответов
=================================
$(echo "$ACCESS_DATA" | awk '{print $9}' | sort | uniq -c | sort -nr)
## Считаем HTTP-коды ответов (9-е поле) и их количество.

=================================
Ошибки веб-сервера
=================================
$(echo "$ERROR_DATA" | tail -n 20)
## Выводим последние 20 строк error-лога за период.
EOF
)

########################################
## ОТПРАВКА ПОЧТЫ
########################################

echo "$REPORT" | mail -s "Web report [$HOSTNAME] $START_TIME — $NOW" "$MAIL_TO"
## Отправляем сформированный отчёт
## через локальную почту сервера пользователю root.
